<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Заполнение данных — генератор Excel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --maxw: 1000px; }
    .container-narrow { max-width: var(--maxw); }
    .card { border:0; box-shadow:0 0.25rem 0.75rem rgba(0,0,0,.06); }
    .section-title { font-weight:600; color:#0d6efd; font-size:1.05rem; margin-bottom:.25rem; }
    .hint { color:#6c757d; font-size:.875rem; }
    .sticky-actions { position:sticky; bottom:0; background:rgba(255,255,255,.9); backdrop-filter:blur(6px); border-top:1px solid rgba(0,0,0,.075); z-index:1030; }
  </style>
</head>
<body class="bg-light">
  <div class="container container-narrow py-4">
    <h1 class="h4 mb-3">Заполнение данных</h1>

    <ul class="nav nav-pills mb-3" id="tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="person-tab" data-bs-toggle="tab" data-bs-target="#person" type="button" role="tab">Прописываемый</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="host-tab" data-bs-toggle="tab" data-bs-target="#host" type="button" role="tab">Принимающий</button>
      </li>
    </ul>

    <form action="/generate" method="post" class="tab-content needs-validation" id="regForm" novalidate>
      <!-- Прописываемый -->
      <div class="tab-pane fade show active" id="person" role="tabpanel" aria-labelledby="person-tab">
        <div class="card mb-4">
          <div class="card-body">
            <div class="section-title">Личные данные</div>
            <div class="hint mb-3">Заполните ФИО, гражданство, даты и документ.</div>

            <div class="row g-3">
              {% for field,label in person_labels.items() %}
                {% if field == 'sex' %}
                  <div class="col-12">
                    <label class="form-label d-block">{{ label }}</label>
                    <div class="btn-group" role="group">
                      <input type="radio" class="btn-check" name="person_sex" id="sexM" value="М" checked>
                      <label class="btn btn-outline-primary" for="sexM">Мужской</label>
                      <input type="radio" class="btn-check" name="person_sex" id="sexF" value="Ж">
                      <label class="btn btn-outline-primary" for="sexF">Женский</label>
                    </div>
                  </div>
                {% else %}
                  {% set l = label|lower %}
                  {% set small = 'день' in l or 'месяц' in l or 'год' in l or 'серия' in l or 'номер' in l %}
                  <div class="{{ 'col-6 col-md-2' if small else 'col-12 col-md-6' }}">
                    <label class="form-label" for="person_{{field}}">{{ label }}</label>
                    <input class="form-control" type="text" id="person_{{field}}" name="person_{{field}}">
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <div class="section-title">Адрес прежнего места пребывания</div>
                <div class="hint">Где проживали ранее.</div>
              </div>
            </div>
            <div class="row g-3">
              {% for field,label in address_labels.items() %}
                <div class="col-12 col-md-6">
                  <label class="form-label" for="person_prev_address_{{field}}">{{ label }}</label>
                  <input class="form-control" type="text" id="person_prev_address_{{field}}" name="person_prev_address_{{field}}">
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <div class="section-title">Адрес места пребывания</div>
                <div class="hint">Адрес для регистрации.</div>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="copyPrevAddr">
                <label class="form-check-label" for="copyPrevAddr">Скопировать из прежнего</label>
              </div>
            </div>
            <div class="row g-3">
              {% for field,label in address_labels.items() %}
                <div class="col-12 col-md-6">
                  <label class="form-label" for="person_reg_address_{{field}}">{{ label }}</label>
                  <input class="form-control" type="text" id="person_reg_address_{{field}}" name="person_reg_address_{{field}}">
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Принимающий -->
      <div class="tab-pane fade" id="host" role="tabpanel" aria-labelledby="host-tab">
        <div class="card mb-4">
          <div class="card-body">
            <div class="section-title">Данные принимающей стороны</div>
            <div class="row g-3">
              {% for field,label in host_labels.items() %}
                <div class="col-12 col-md-6">
                  <label class="form-label" for="host_{{field}}">{{ label }}</label>
                  <input class="form-control" type="text" id="host_{{field}}" name="host_{{field}}">
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-body">
            <div class="section-title">Адрес проживания принимающей стороны</div>
            <div class="row g-3">
              {% for field,label in address_labels.items() %}
                <div class="col-12 col-md-6">
                  <label class="form-label" for="host_residence_{{field}}">{{ label }}</label>
                  <input class="form-control" type="text" id="host_residence_{{field}}" name="host_residence_{{field}}">
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Действия -->
      <div class="sticky-actions p-3 d-flex gap-2 justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <div class="progress" style="width:220px" aria-label="Заполнено">
            <div class="progress-bar" role="progressbar" style="width:0%" id="fillProgress" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          <span class="hint" id="filledCount">0 полей</span>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary" id="resetForm">Очистить</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <span class="default">Скачать Excel</span>
            <span class="loading d-none"><span class="spinner-border spinner-border-sm me-2"></span>Формирование…</span>
          </button>
        </div>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // автосохранение
    (function(){
      const KEY='regFormDataV2'; const form=document.getElementById('regForm');
      try {
        const data=JSON.parse(localStorage.getItem(KEY)||'{}');
        Object.entries(data).forEach(([k,v])=>{ const el=form.elements.namedItem(k); if(!el) return;
          if(el.type==='radio'){ const r=form.querySelector(`[name="${el.name}"][value="${v}"]`); if(r) r.checked=true; }
          else el.value=v;
        });
      } catch(e){}
      form.addEventListener('input',()=>{
        const data={};
        Array.from(form.elements).forEach(el=>{
          if(!el.name) return;
          if(el.type==='radio'){ if(el.checked) data[el.name]=el.value; }
          else if(el.type!=='submit' && el.type!=='button'){ data[el.name]=el.value; }
        });
        localStorage.setItem(KEY, JSON.stringify(data));
        progress();
      });
      document.getElementById('resetForm').addEventListener('click',()=>{
        form.reset(); localStorage.removeItem(KEY); progress();
      });
    })();

    // копирование адреса прежнего в текущий
    (function(){
      const sw=document.getElementById('copyPrevAddr'); const form=document.getElementById('regForm');
      sw?.addEventListener('change',()=>{
        const prev=Array.from(form.elements).filter(e=>e.name?.startsWith('person_prev_address_'));
        const reg =Array.from(form.elements).filter(e=>e.name?.startsWith('person_reg_address_'));
        if(sw.checked){
          reg.forEach(dst=>{
            const suf=dst.name.replace('person_reg_address_','');
            const src=form.elements.namedItem('person_prev_address_'+suf);
            if(src) dst.value=src.value;
          });
          form.dispatchEvent(new Event('input'));
        }
      });
    })();

    // прогресс
    function progress(){
      const form=document.getElementById('regForm');
      const inputs=Array.from(form.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], select'));
      const filled=inputs.filter(i=>String(i.value).trim().length>0).length;
      const total=inputs.length; const p=total?Math.round(filled*100/total):0;
      const bar=document.getElementById('fillProgress'); const cnt=document.getElementById('filledCount');
      bar.style.width=p+'%'; bar.textContent=p+'%'; cnt.textContent=filled+' из '+total;
    }
    document.addEventListener('DOMContentLoaded', progress);

    // визуал для submit/валидация
    (function(){
      const form=document.getElementById('regForm'); const btn=document.getElementById('submitBtn');
      form.addEventListener('submit',function(e){
        btn.querySelector('.default').classList.add('d-none');
        btn.querySelector('.loading').classList.remove('d-none');
        if(!form.checkValidity()){ e.preventDefault(); e.stopPropagation();
          btn.querySelector('.default').classList.remove('d-none');
          btn.querySelector('.loading').classList.add('d-none');
        }
        form.classList.add('was-validated');
      });
    })();
  </script>
</body>
</html>
